<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Party Pixels · Profile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/pp-main.css" />
</head>
<body>
  <!-- DEBUG BOX (HTML, zawsze widoczny) -->
  <div id="ppDebugBox" style="
    position:fixed; top:12px; right:12px; z-index:999999;
    font-size:12px; padding:6px 10px; border-radius:999px;
    border:1px solid rgba(36,39,58,0.9);
    background:rgba(6, 9, 24, 0.88);
    color:#f4f4ff;
  ">
    JS not started
  </div>

  <div class="page">
    <div id="header"></div>

    <main class="pp-profile">
      <a href="/index.html" class="pp-back-link">← Back</a>

      <section class="pp-profile-hero">
        <div class="pp-profile-title-row">
          <div class="pp-profile-avatar" id="ppProfileAvatar">?</div>
          <div>
            <h1 class="pp-profile-title" id="ppProfileName">Loading…</h1>
            <div class="pp-profile-meta" id="ppProfileMeta"></div>
          </div>
        </div>

        <p class="pp-profile-bio" id="ppProfileBio"></p>

        <div class="pp-profile-actions">
          <button class="pp-btn pp-btn-ghost" id="ppCopyUserId">Copy user id</button>
          <button class="pp-btn pp-btn-danger" data-pp-logout>Log out</button>
        </div>

        <p class="pp-profile-error" id="ppProfileError" style="display:none;"></p>
      </section>

      <section class="pp-card" id="ppStatsCard" style="display:none;">
        <div class="pp-card-title">Game stats</div>
        <div class="pp-stat-row">
          <div class="pp-stat-label">Tap to Survive – best run</div>
          <div class="pp-stat-value" id="ppStatTTS">–</div>
        </div>
      </section>
    </main>

    <div id="footer"></div>
  </div>

  <!-- PARTS loader -->
  <script>
    function loadPart(id, file, cb) {
      fetch(file)
        .then(r => r.text())
        .then(html => {
          const el = document.getElementById(id);
          if (el) el.innerHTML = html;
          if (typeof cb === "function") cb();
        })
        .catch(err => console.error("Load error:", file, err));
    }

    loadPart("header", "/header.html", () => {
      if (window.ppUpdateUserButton) window.ppUpdateUserButton();
    });
    loadPart("footer", "/footer.html");
  </script>

  <!-- Supabase + auth + tipjar -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
  <script src="/pp-auth.js?v=2002" defer></script>
  <script src="/tipjar.js" defer></script>

  <!-- Profile logic -->
  <script>
    // 1) TWARDY sygnał, czy JS odpalił
    const dbg = document.getElementById("ppDebugBox");
    dbg.textContent = "JS started…";

    // routing
    const PP_LOGIN_URL = "/account.html";

    // same project as pp-auth.js
    const SUPABASE_URL = "https://dyfrzwxhycqnqntvkuxy.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR5ZnJ6d3hoeWNxbnFudHZrdXh5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1ODM5MjgsImV4cCI6MjA4MDE1OTkyOH0.n4jP0q7YZY-jQaSnHUkKWyI9wM02iHXnRXS31AATnY0";

    const nameEl = document.getElementById("ppProfileName");
    const metaEl = document.getElementById("ppProfileMeta");
    const bioEl  = document.getElementById("ppProfileBio");
    const errEl  = document.getElementById("ppProfileError");
    const avatarEl = document.getElementById("ppProfileAvatar");

    const statsCard = document.getElementById("ppStatsCard");
    const statTTS   = document.getElementById("ppStatTTS");
    const copyBtn   = document.getElementById("ppCopyUserId");

    function showError(msg) {
      errEl.textContent = msg;
      errEl.style.display = "block";
    }
    function hideError() {
      errEl.style.display = "none";
      errEl.textContent = "";
    }
    function initialFromName(name) {
      const s = (name || "").trim();
      return s ? s.charAt(0).toUpperCase() : "?";
    }

    function waitForSupabaseSDK(cb, startedAt = Date.now()) {
      if (window.supabase && typeof window.supabase.createClient === "function") return cb();
      if (Date.now() - startedAt > 4000) {
        dbg.textContent = "SDK missing";
        showError("Supabase SDK not loaded.");
        return;
      }
      setTimeout(() => waitForSupabaseSDK(cb, startedAt), 50);
    }

    async function init() {
      hideError();
      metaEl.textContent = "Booting…";
      dbg.textContent = "booting…";

      waitForSupabaseSDK(async () => {
        try {
          dbg.textContent = "client…";

          // Prefer shared client from pp-auth.js; fallback to local
          const sb =
            window.ppSupabaseClient ||
            window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

          dbg.textContent = "getUser…";
          metaEl.textContent = "Loading session…";

          // getUser is often more reliable on mobile than only getSession
          const { data: userRes, error: userErr } = await sb.auth.getUser();
          if (userErr) {
            dbg.textContent = "auth error";
            showError("Auth error (getUser).");
            return;
          }

          const user = userRes?.user;
          if (!user) {
            dbg.textContent = "no user → redirect";
            window.location.href = PP_LOGIN_URL;
            return;
          }

          const uid = user.id;
          const email = user.email || "";
          const meta = user.user_metadata || {};
          const fallbackName =
            meta.display_name ||
            meta.username ||
            (email ? email.split("@")[0] : "Player");

          nameEl.textContent = fallbackName || "Player";
          avatarEl.textContent = initialFromName(fallbackName);
          bioEl.textContent = "";

          if (copyBtn) {
            copyBtn.addEventListener("click", async () => {
              try {
                await navigator.clipboard.writeText(uid);
                copyBtn.textContent = "Copied!";
                setTimeout(() => (copyBtn.textContent = "Copy user id"), 900);
              } catch {
                showError("Clipboard blocked by browser.");
              }
            });
          }

          dbg.textContent = "profiles select…";
          metaEl.textContent = "Loading profile…";

          const { data: prof, error: profErr } = await sb
            .from("profiles")
            .select("display_name, bio, created_at")
            .eq("user_id", uid)
            .maybeSingle();

          if (profErr) {
            dbg.textContent = "profiles blocked";
            showError("Could not load profile (RLS/policy?).");
            return;
          }

          const displayName = (prof && prof.display_name) ? prof.display_name : (fallbackName || "Player");
          nameEl.textContent = displayName;
          avatarEl.textContent = initialFromName(displayName);

          if (prof && prof.created_at) {
            const created = new Date(prof.created_at);
            const dateText = created.toLocaleDateString(undefined, { year: "numeric", month: "short", day: "numeric" });
            metaEl.textContent = `Member since ${dateText}`;
          } else {
            metaEl.textContent = "";
          }

          bioEl.textContent = (prof && prof.bio) ? prof.bio : "";

          dbg.textContent = "stats…";
          const { data: stat, error: statErr } = await sb
            .from("tts_scores")
            .select("score")
            .eq("user_id", uid)
            .order("score", { ascending: false })
            .limit(1);

          if (!statErr && stat && stat.length) {
            statTTS.textContent = `${Number(stat[0].score).toFixed(1)} s`;
            statsCard.style.display = "block";
          }

          dbg.textContent = "done ✅";
        } catch (e) {
          console.error("Profile init crash:", e);
          dbg.textContent = "crash";
          showError("Profile script crashed.");
        }
      });
    }

    // odpal po chwili (żeby defer scripts miały czas)
    setTimeout(init, 0);
  </script>
</body>
</html>
