<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Party Pixels · Profile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/pp-main.css" />
</head>
<body>
  <div class="page">
    <div id="header"></div>

    <main class="pp-profile">
      <a href="/index.html" class="pp-back-link">← Back</a>

      <section class="pp-profile-hero">
        <div class="pp-profile-title-row">
          <div class="pp-profile-avatar" id="ppProfileAvatar">?</div>

          <div class="pp-profile-title-col">
            <!-- VIEW MODE -->
            <h1 class="pp-profile-title" id="ppProfileName">Loading…</h1>
            <div class="pp-profile-meta" id="ppProfileMeta"></div>

            <!-- EDIT MODE (hidden by default) -->
            <div class="pp-profile-edit" id="ppEditWrap" style="display:none;">
              <label class="pp-field">
                <span class="pp-field-label">Display name</span>
                <input class="pp-input" id="ppEditName" type="text" maxlength="24" autocomplete="nickname" />
              </label>

              <label class="pp-field">
                <span class="pp-field-label">Bio</span>
                <textarea class="pp-textarea" id="ppEditBio" rows="3" maxlength="240"></textarea>
                <span class="pp-field-hint" id="ppBioCount">0 / 240</span>
              </label>
            </div>
          </div>
        </div>

        <!-- VIEW MODE bio -->
        <p class="pp-profile-bio" id="ppProfileBio"></p>

        <div class="pp-profile-actions">
          <button class="pp-btn pp-btn-ghost" id="ppCopyUserId" type="button">Copy user id</button>

          <!-- Edit / Save / Cancel -->
          <button class="pp-btn" id="ppEditBtn" type="button">Edit profile</button>

          <button class="pp-btn pp-btn-accent" id="ppSaveBtn" type="button" style="display:none;">
            Save
          </button>
          <button class="pp-btn pp-btn-ghost" id="ppCancelBtn" type="button" style="display:none;">
            Cancel
          </button>

          <button class="pp-btn pp-btn-danger" id="ppHardLogout" type="button">Log out</button>
        </div>

        <p class="pp-profile-error" id="ppProfileError" style="display:none;"></p>
        <p class="pp-profile-success" id="ppProfileSuccess" style="display:none;"></p>
      </section>

      <section class="pp-card" id="ppStatsCard" style="display:none;">
        <div class="pp-card-title">Game stats</div>
        <div class="pp-stat-row">
          <div class="pp-stat-label">Tap to Survive – best run</div>
          <div class="pp-stat-value" id="ppStatTTS">–</div>
        </div>
      </section>
    </main>

    <div id="footer"></div>
  </div>

  <!-- PARTS loader -->
  <script>
    function loadPart(id, file) {
      fetch(file)
        .then(r => r.text())
        .then(html => {
          const el = document.getElementById(id);
          if (el) el.innerHTML = html;
        })
        .catch(err => console.error("Load error:", file, err));
    }

    loadPart("header", "/header.html");
    loadPart("footer", "/footer.html");
  </script>

  <!-- Supabase + auth + tipjar -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
  <script src="/pp-auth.js?v=5001" defer></script>
  <script src="/tipjar.js" defer></script>

  <!-- Profile logic -->
  <script>
    const PP_LOGIN_URL = "/account.html";

    // keep in sync with pp-auth.js
    const SUPABASE_URL = "https://dyfrzwxhycqnqntvkuxy.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR5ZnJ6d3hoeWNxbnFudHZrdXh5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1ODM5MjgsImV4cCI6MjA4MDE1OTkyOH0.n4jP0q7YZY-jQaSnHUkKWyI9wM02iHXnRXS31AATnY0";

    const nameEl   = document.getElementById("ppProfileName");
    const metaEl   = document.getElementById("ppProfileMeta");
    const bioEl    = document.getElementById("ppProfileBio");
    const errEl    = document.getElementById("ppProfileError");
    const okEl     = document.getElementById("ppProfileSuccess");
    const avatarEl = document.getElementById("ppProfileAvatar");

    const statsCard = document.getElementById("ppStatsCard");
    const statTTS   = document.getElementById("ppStatTTS");

    const copyBtn   = document.getElementById("ppCopyUserId");
    const logoutBtn = document.getElementById("ppHardLogout");

    const editBtn   = document.getElementById("ppEditBtn");
    const saveBtn   = document.getElementById("ppSaveBtn");
    const cancelBtn = document.getElementById("ppCancelBtn");
    const editWrap  = document.getElementById("ppEditWrap");
    const editName  = document.getElementById("ppEditName");
    const editBio   = document.getElementById("ppEditBio");
    const bioCount  = document.getElementById("ppBioCount");

    let sb = null;
    let currentUser = null;
    let currentProfile = { display_name: "", bio: "", created_at: null };

    function showError(msg) {
      errEl.textContent = msg;
      errEl.style.display = "block";
      okEl.style.display = "none";
      okEl.textContent = "";
    }
    function showOk(msg) {
      okEl.textContent = msg;
      okEl.style.display = "block";
      errEl.style.display = "none";
      errEl.textContent = "";
      setTimeout(() => { okEl.style.display = "none"; }, 1200);
    }
    function hideMsgs() {
      errEl.style.display = "none";
      errEl.textContent = "";
      okEl.style.display = "none";
      okEl.textContent = "";
    }

    function initialFromName(name) {
      const s = (name || "").trim();
      return s ? s.charAt(0).toUpperCase() : "?";
    }

    // hard header update for THIS page (żeby nie było "Login")
    function hardUpdateHeader(name) {
      const btn = document.querySelector("[data-pp-user-button]");
      const label = document.querySelector("[data-pp-user-label]");
      const av = document.querySelector("[data-pp-user-avatar]");
      if (!btn || !label || !av) return;

      label.textContent = name || "User";
      av.textContent = initialFromName(name);
      av.style.display = "inline-flex";
      btn.href = "/profile.html";
    }

    function waitForSupabaseSDK(cb, startedAt = Date.now()) {
      if (window.supabase && typeof window.supabase.createClient === "function") return cb();
      if (Date.now() - startedAt > 4000) {
        showError("Supabase SDK not loaded.");
        return;
      }
      setTimeout(() => waitForSupabaseSDK(cb, startedAt), 50);
    }

    function setEditMode(on) {
      if (on) {
        editWrap.style.display = "block";
        saveBtn.style.display = "inline-flex";
        cancelBtn.style.display = "inline-flex";
        editBtn.style.display = "none";
        bioEl.style.display = "none";

        // fill inputs from currentProfile
        editName.value = currentProfile.display_name || nameEl.textContent || "";
        editBio.value = currentProfile.bio || bioEl.textContent || "";
        updateBioCount();
      } else {
        editWrap.style.display = "none";
        saveBtn.style.display = "none";
        cancelBtn.style.display = "none";
        editBtn.style.display = "inline-flex";
        bioEl.style.display = "";
      }
    }

    function updateBioCount() {
      const len = (editBio.value || "").length;
      bioCount.textContent = `${len} / 240`;
    }
    editBio.addEventListener("input", updateBioCount);

    function validateDisplayName(raw) {
      const name = (raw || "").trim();

      // 2–20 chars
      if (name.length < 2) return { ok:false, msg:"Display name too short (min 2)." };
      if (name.length > 20) return { ok:false, msg:"Display name too long (max 20)." };

      // allow: letters, numbers, underscore, dash, dot
      if (!/^[A-Za-z0-9._-]+$/.test(name)) {
        return { ok:false, msg:"Use only letters, numbers, . _ - (no spaces)." };
      }

      return { ok:true, value:name };
    }

    function normalizeBio(raw) {
      const bio = (raw || "").trim();
      if (bio.length > 240) return { ok:false, msg:"Bio too long (max 240)." };
      return { ok:true, value:bio };
    }

    async function loadProfileAndStats() {
      hideMsgs();
      metaEl.textContent = "Loading profile…";

      // user metadata fallback name
      const email = currentUser.email || "";
      const meta = currentUser.user_metadata || {};
      const fallbackName =
        meta.display_name ||
        meta.username ||
        (email ? email.split("@")[0] : "Player");

      // Header + basic UI asap
      nameEl.textContent = fallbackName || "Player";
      avatarEl.textContent = initialFromName(fallbackName);
      hardUpdateHeader(fallbackName);

      // Try to load profile row
      const uid = currentUser.id;

      const { data: prof, error: profErr } = await sb
        .from("profiles")
        .select("display_name, bio, created_at")
        .eq("user_id", uid)
        .maybeSingle();

      if (profErr) {
        console.error("Profile load error:", profErr);
        showError("Could not load profile.");
        metaEl.textContent = "";
      } else {
        const displayName = (prof && prof.display_name) ? prof.display_name : (fallbackName || "Player");
        const bio = (prof && prof.bio) ? prof.bio : "";

        currentProfile.display_name = displayName;
        currentProfile.bio = bio;
        currentProfile.created_at = prof ? prof.created_at : null;

        nameEl.textContent = displayName;
        avatarEl.textContent = initialFromName(displayName);
        bioEl.textContent = bio;

        hardUpdateHeader(displayName);

        if (prof && prof.created_at) {
          const created = new Date(prof.created_at);
          const dateText = created.toLocaleDateString(undefined, { year:"numeric", month:"short", day:"numeric" });
          metaEl.textContent = `Member since ${dateText}`;
        } else {
          metaEl.textContent = "";
        }
      }

      // Stats
      const { data: stat, error: statErr } = await sb
        .from("tts_scores")
        .select("score")
        .eq("user_id", uid)
        .order("score", { ascending: false })
        .limit(1);

      if (!statErr && stat && stat.length) {
        statTTS.textContent = `${Number(stat[0].score).toFixed(1)} s`;
        statsCard.style.display = "block";
      }
    }

    async function initProfile() {
      waitForSupabaseSDK(async () => {
        sb = window.ppSupabaseClient || window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Guard
        const { data: userRes, error: userErr } = await sb.auth.getUser();
        if (userErr) {
          showError("Auth error.");
          return;
        }
        currentUser = userRes?.user;
        if (!currentUser) {
          window.location.href = PP_LOGIN_URL;
          return;
        }

        // Copy uid
        copyBtn.addEventListener("click", async () => {
          try {
            await navigator.clipboard.writeText(currentUser.id);
            copyBtn.textContent = "Copied!";
            setTimeout(() => (copyBtn.textContent = "Copy user id"), 900);
          } catch {
            showError("Clipboard blocked by browser.");
          }
        });

        // Logout (hard)
        logoutBtn.addEventListener("click", async () => {
          logoutBtn.disabled = true;
          const old = logoutBtn.textContent;
          logoutBtn.textContent = "Logging out…";
          try { await sb.auth.signOut(); } catch (e) { console.error(e); }
          window.location.href = PP_LOGIN_URL;
          logoutBtn.textContent = old;
          logoutBtn.disabled = false;
        });

        // Edit handlers
        editBtn.addEventListener("click", () => {
          hideMsgs();
          setEditMode(true);
        });

        cancelBtn.addEventListener("click", () => {
          hideMsgs();
          setEditMode(false);
        });

        saveBtn.addEventListener("click", async () => {
          hideMsgs();

          const vName = validateDisplayName(editName.value);
          if (!vName.ok) return showError(vName.msg);

          const vBio = normalizeBio(editBio.value);
          if (!vBio.ok) return showError(vBio.msg);

          const newName = vName.value;
          const newBio = vBio.value;

          // loading state
          saveBtn.disabled = true;
          cancelBtn.disabled = true;
          editName.disabled = true;
          editBio.disabled = true;
          const oldSave = saveBtn.textContent;
          saveBtn.textContent = "Saving…";

          try {
            const uid = currentUser.id;

            // 1) Upsert profile row
            const { error: upErr } = await sb
              .from("profiles")
              .upsert(
                { user_id: uid, display_name: newName, bio: newBio },
                { onConflict: "user_id" }
              );

            if (upErr) {
  console.error("Upsert error:", upErr);
  showError(`Could not save profile: ${upErr.message || "unknown error"}`);
  return;
            }

            // 2) Update auth metadata (żeby global header mógł brać display_name)
            const { error: metaErr } = await sb.auth.updateUser({
              data: { display_name: newName }
            });

            if (metaErr) {
              // nie blokujemy (profil i tak zapisany), ale logujemy
              console.warn("Metadata update error:", metaErr);
            }

            // UI update
            currentProfile.display_name = newName;
            currentProfile.bio = newBio;

            nameEl.textContent = newName;
            bioEl.textContent = newBio;
            avatarEl.textContent = initialFromName(newName);
            hardUpdateHeader(newName);

            // jeśli pp-auth ma swoją funkcję — też spróbuj
            if (window.ppUpdateUserButton) {
              try { await window.ppUpdateUserButton(); } catch {}
            }

            setEditMode(false);
            showOk("Saved.");

          } finally {
            saveBtn.disabled = false;
            cancelBtn.disabled = false;
            editName.disabled = false;
            editBio.disabled = false;
            saveBtn.textContent = oldSave;
          }
        });

        await loadProfileAndStats();
      });
    }

    setTimeout(initProfile, 0);
  </script>
</body>
</html>
