<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Party Pixels · Account</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/pp-main.css" />
</head>
<body>
  <div class="page">
    <div id="header"></div>

    <main class="pp-profile">
      <a href="/index.html" class="pp-back-link">← Back</a>

      <section class="pp-profile-hero">
        <div class="pp-profile-title-row">
          <div class="pp-profile-avatar" id="ppProfileAvatar">?</div>
          <div>
            <h1 class="pp-profile-title" id="ppProfileName">Loading…</h1>
            <div class="pp-profile-meta" id="ppProfileMeta"></div>
          </div>
        </div>

        <p class="pp-profile-bio" id="ppProfileBio"></p>

        <div class="pp-profile-actions">
          <button class="pp-btn pp-btn-ghost" id="ppCopyUserId">Copy user id</button>
          <button class="pp-btn pp-btn-danger" data-pp-logout>Log out</button>
        </div>

        <p class="pp-profile-error" id="ppProfileError" style="display:none;"></p>
      </section>

      <section class="pp-card" id="ppStatsCard" style="display:none;">
        <div class="pp-card-title">Game stats</div>

        <div class="pp-stat-row">
          <div class="pp-stat-label">Tap to Survive – best run</div>
          <div class="pp-stat-value" id="ppStatTTS">–</div>
        </div>

        <!-- możesz dopinać kolejne staty tu -->
      </section>
    </main>

    <div id="footer"></div>
  </div>

  <!-- PARTS loader -->
  <script>
    function loadPart(id, file, cb) {
      fetch(file)
        .then(r => r.text())
        .then(html => {
          const el = document.getElementById(id);
          if (el) el.innerHTML = html;
          if (typeof cb === "function") cb();
        })
        .catch(err => console.error("Load error:", file, err));
    }

    loadPart("header", "/header.html", () => {
      if (window.ppUpdateUserButton) window.ppUpdateUserButton();
    });
    loadPart("footer", "/footer.html");
  </script>

  <!-- Supabase + auth + tipjar -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/pp-auth.js"></script>
  <script src="/tipjar.js"></script>

  <!-- Account logic -->
  <script>
    const nameEl = document.getElementById("ppProfileName");
    const metaEl = document.getElementById("ppProfileMeta");
    const bioEl  = document.getElementById("ppProfileBio");
    const errEl  = document.getElementById("ppProfileError");
    const avatarEl = document.getElementById("ppProfileAvatar");

    const statsCard = document.getElementById("ppStatsCard");
    const statTTS   = document.getElementById("ppStatTTS");
    const copyBtn   = document.getElementById("ppCopyUserId");

    // bierzemy klienta z pp-auth.js
    const sb = window.ppSupabaseClient || window.ppSupabase;
    if (!sb) {
      console.error("No Supabase client found. Expose it from pp-auth.js as window.ppSupabaseClient or window.ppSupabase.");
    }

    function showError(msg) {
      errEl.textContent = msg;
      errEl.style.display = "block";
    }

    function hideError() {
      errEl.style.display = "none";
      errEl.textContent = "";
    }

    function initialFromName(name) {
      const s = (name || "").trim();
      return s ? s.charAt(0).toUpperCase() : "?";
    }

    async function initAccount() {
      if (!sb) {
        showError("Supabase client missing.");
        return;
      }

      hideError();

      // 1) session
      const { data: { session }, error: sessErr } = await sb.auth.getSession();
      if (sessErr) {
        console.error("Session error:", sessErr);
        showError("Session error.");
        return;
      }

      if (!session || !session.user) {
        // niezalogowany → przerzut na login
        window.location.href = "/login.html";
        return;
      }

      const uid = session.user.id;
      const email = session.user.email || "";
      const meta = session.user.user_metadata || {};
      const fallbackName = meta.display_name || meta.username || (email ? email.split("@")[0] : "Player");

      // UI base
      nameEl.textContent = fallbackName || "Player";
      avatarEl.textContent = initialFromName(fallbackName);
      metaEl.textContent = "Loading profile…";

      if (copyBtn) {
        copyBtn.addEventListener("click", async () => {
          try {
            await navigator.clipboard.writeText(uid);
            copyBtn.textContent = "Copied!";
            setTimeout(() => (copyBtn.textContent = "Copy user id"), 900);
          } catch {
            // fallback
            showError("Clipboard blocked by browser.");
          }
        });
      }

      // 2) load profile row
      await loadProfile(uid, fallbackName);

      // 3) load stats
      await loadStats(uid);
    }

    async function loadProfile(uid, fallbackName) {
      try {
        const { data, error } = await sb
          .from("profiles")
          .select("display_name, bio, created_at")
          .eq("user_id", uid)
          .maybeSingle();

        if (error) {
          console.error("Profile load error:", error);
          metaEl.textContent = "";
          showError("Could not load profile.");
          return;
        }

        const displayName = (data && data.display_name) ? data.display_name : (fallbackName || "Player");
        nameEl.textContent = displayName;
        avatarEl.textContent = initialFromName(displayName);

        if (data && data.created_at) {
          const created = new Date(data.created_at);
          const dateText = created.toLocaleDateString(undefined, { year: "numeric", month: "short", day: "numeric" });
          metaEl.textContent = `Member since ${dateText}`;
        } else {
          metaEl.textContent = "";
        }

        bioEl.textContent = (data && data.bio) ? data.bio : "";
      } catch (e) {
        console.error("Unexpected profile error:", e);
        metaEl.textContent = "";
        showError("Unexpected error loading profile.");
      }
    }

    async function loadStats(uid) {
      try {
        const { data, error } = await sb
          .from("tts_scores")
          .select("score, created_at")
          .eq("user_id", uid)
          .order("score", { ascending: false })
          .limit(1);

        if (error) {
          console.error("Stats load error:", error);
          return;
        }

        if (data && data.length) {
          const best = data[0];
          statTTS.textContent = `${Number(best.score).toFixed(1)} s`;
          statsCard.style.display = "block";
        }
      } catch (e) {
        console.error("Unexpected stats error:", e);
      }
    }

    document.addEventListener("DOMContentLoaded", initAccount);
  </script>
</body>
</html>
