<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Party Pixels · Profile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/pp-main.css" />

  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9279891303822612"
     crossorigin="anonymous"></script>

  <!-- PROFILE PAGE OVERRIDES (layout like the 2nd screenshot) -->
  <style>
    /* Page spacing (keeps your global styles intact) uiop*/
    .pp-profile {
      width: min(1180px, calc(100% - 32px));
      margin: 0 auto;
      padding: 22px 0 40px;
    }

    /* HERO CARD */
    .pp-profile-hero {
      position: relative;
      border-radius: 22px;
      padding: 22px;
      overflow: hidden;

      /* glassy gradient like screenshot */
      background:
        radial-gradient(1200px 600px at 0% 0%, rgba(160, 90, 255, .22), transparent 55%),
        radial-gradient(1000px 500px at 60% 40%, rgba(70, 120, 255, .18), transparent 55%),
        linear-gradient(180deg, rgba(10, 12, 22, .72), rgba(8, 10, 18, .82));
      border: 1px solid rgba(255,255,255,.10);
      box-shadow:
        0 18px 55px rgba(0,0,0,.45),
        inset 0 1px 0 rgba(255,255,255,.05);
      backdrop-filter: blur(10px);
    }

    /* Two-column hero layout */
    .pp-profile-hero-grid {
      display: grid;
      grid-template-columns: 360px 1fr;
      gap: 22px;
      align-items: start;
    }

    @media (max-width: 920px) {
      .pp-profile-hero-grid {
        grid-template-columns: 1fr;
      }
    }

    /* LEFT COLUMN */
    .pp-profile-left {
      display: grid;
      grid-template-columns: 132px 1fr;
      gap: 16px;
      align-items: center;
    }

    @media (max-width: 520px) {
      .pp-profile-left {
        grid-template-columns: 104px 1fr;
      }
    }

    /* Avatar as square card with inner circle (like your mock) */
    .pp-profile-avatar-card {
      width: 132px;
      height: 132px;
      border-radius: 18px;
      display: grid;
      place-items: center;
      background:
        radial-gradient(120px 120px at 30% 30%, rgba(190, 120, 255, .35), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.10);
      box-shadow:
        0 12px 30px rgba(0,0,0,.35),
        inset 0 1px 0 rgba(255,255,255,.06);
    }

    @media (max-width: 520px) {
      .pp-profile-avatar-card { width: 104px; height: 104px; border-radius: 16px; }
    }

    /* The actual avatar element you already use in JS */
    .pp-profile-avatar {
      width: 92px;
      height: 92px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      letter-spacing: .02em;
      user-select: none;

      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.18), rgba(255,255,255,.06));
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 10px 24px rgba(0,0,0,.35);
      color: rgba(255,255,255,.92);
      font-size: 34px;
    }

    @media (max-width: 520px) {
      .pp-profile-avatar { width: 74px; height: 74px; font-size: 28px; }
    }

    .pp-profile-title {
      margin: 0;
      line-height: 1.05;
      font-size: 44px;
      letter-spacing: -0.02em;
      color: rgba(255,255,255,.95);
      text-shadow: 0 2px 10px rgba(0,0,0,.35);
    }

    @media (max-width: 520px) {
      .pp-profile-title { font-size: 34px; }
    }

    .pp-profile-meta {
      margin-top: 8px;
      font-size: 14px;
      opacity: .75;
    }

    /* RIGHT COLUMN (bio bubble / edit panel) */
    .pp-profile-right {
      display: grid;
      gap: 12px;
    }

    .pp-profile-bio-bubble {
      display: inline-block;
      width: fit-content;
      max-width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.05);
      color: rgba(255,255,255,.86);
      font-size: 14px;
      line-height: 1.35;
    }

    /* Make it look like the bubble is "floating" on the right */
    .pp-profile-right .pp-profile-bio-bubble {
      margin-top: 4px;
    }

    /* EDIT FORM should also look like a panel on the right */
    .pp-profile-edit {
      padding: 12px;
      border-radius: 14px;
      background: rgba(0,0,0,.26);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.05);
    }

    .pp-field { display: grid; gap: 6px; margin: 10px 0; }
    .pp-field-label { font-size: 12px; opacity: .75; }
    .pp-field-hint { font-size: 12px; opacity: .65; }

    /* ACTIONS: bottom-right */
    .pp-profile-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      align-items: center;
      flex-wrap: wrap;
      margin-top: 14px;
    }

    /* Messages */
    .pp-profile-error,
    .pp-profile-success {
      margin: 10px 0 0;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
      max-width: 100%;
    }

    /* STATS card spacing (keep your existing .pp-card) */
    #ppStatsCard {
      margin-top: 16px;
    }

    /* Small quality-of-life: keep the back link aligned with screenshot */
    .pp-back-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin: 8px 0 14px;
      opacity: .8;
      text-decoration: none;
    }
  </style>
</head>

<body>
  <div class="page">
    <div id="header"></div>

    <main class="pp-profile">
      <a href="/index.html" class="pp-back-link">← Back</a>

      <section class="pp-profile-hero" style="min-height:400px">
        <div class="pp-profile-hero-grid">
          <!-- LEFT -->
          <div class="pp-profile-left">
            <div class="pp-profile-avatar-card">
              <div class="pp-profile-avatar" id="ppProfileAvatar">?</div>
            </div>

            <div class="pp-profile-title-col">
              <h1 class="pp-profile-title" id="ppProfileName">Loading…</h1>
              <div class="pp-profile-meta" id="ppProfileMeta"></div>
            </div>
          </div>

          <!-- RIGHT -->
          <div class="pp-profile-right">
            <!-- VIEW MODE bio (bubble) -->
            <div class="pp-profile-bio-bubble" id="ppProfileBio"></div>

            <!-- EDIT MODE (hidden by default) -->
            <div class="pp-profile-edit" id="ppEditWrap" style="display:none;">
              <label class="pp-field">
                <span class="pp-field-label">Display name</span>
                <input class="pp-input" id="ppEditName" type="text" maxlength="24" autocomplete="nickname" />
              </label>

              <label class="pp-field">
                <span class="pp-field-label">Bio</span>
                <textarea class="pp-textarea" id="ppEditBio" rows="3" maxlength="240"></textarea>
                <span class="pp-field-hint" id="ppBioCount">0 / 240</span>
              </label>
            </div>

            <!-- Actions bottom-right -->
            <div class="pp-profile-actions">
              <button class="pp-btn pp-btn-ghost" id="ppCopyUserId" type="button">Copy user id</button>

              <button class="pp-btn" id="ppEditBtn" type="button">Edit profile</button>

              <button class="pp-btn pp-btn-accent" id="ppSaveBtn" type="button" style="display:none;">
                Save
              </button>
              <button class="pp-btn pp-btn-ghost" id="ppCancelBtn" type="button" style="display:none;">
                Cancel
              </button>

              <button class="pp-btn pp-btn-danger" id="ppHardLogout" type="button">Log out</button>
            </div>

            <p class="pp-profile-error" id="ppProfileError" style="display:none;"></p>
            <p class="pp-profile-success" id="ppProfileSuccess" style="display:none;"></p>
          </div>
        </div>
      </section>

      <!-- STATS (rendered dynamically from toy_scores) -->
      <section class="pp-card" id="ppStatsCard" style="display:none; margin-top:150px;">
        <div class="pp-card-title">Game stats</div>
      </section>
    </main>

    <div id="footer"></div>
  </div>

  <!-- PARTS loader -->
  <script>
    function loadPart(id, file) {
      fetch(file)
        .then(r => r.text())
        .then(html => {
          const el = document.getElementById(id);
          if (el) el.innerHTML = html;
        })
        .catch(err => console.error("Load error:", file, err));
    }

    loadPart("header", "/header.html");
    loadPart("footer", "/footer.html");
  </script>

  <!-- Supabase + auth + tipjar -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" defer></script>
  <script src="/pp-auth.js?v=5002" defer></script>
  <script src="/tipjar.js" defer></script>

  <!-- Profile logic -->
  <script>
    const PP_LOGIN_URL = "/account.html";

    // keep in sync with pp-auth.js
    const SUPABASE_URL = "https://dyfrzwxhycqnqntvkuxy.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR5ZnJ6d3hoeWNxbnFudHZrdXh5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1ODM5MjgsImV4cCI6MjA4MDE1OTkyOH0.n4jP0q7YZY-jQaSnHUkKWyI9wM02iHXnRXS31AATnY0";

    const nameEl   = document.getElementById("ppProfileName");
    const metaEl   = document.getElementById("ppProfileMeta");
    const bioEl    = document.getElementById("ppProfileBio");
    const errEl    = document.getElementById("ppProfileError");
    const okEl     = document.getElementById("ppProfileSuccess");
    const avatarEl = document.getElementById("ppProfileAvatar");

    const statsCard = document.getElementById("ppStatsCard");

    const copyBtn   = document.getElementById("ppCopyUserId");
    const logoutBtn = document.getElementById("ppHardLogout");

    const editBtn   = document.getElementById("ppEditBtn");
    const saveBtn   = document.getElementById("ppSaveBtn");
    const cancelBtn = document.getElementById("ppCancelBtn");
    const editWrap  = document.getElementById("ppEditWrap");
    const editName  = document.getElementById("ppEditName");
    const editBio   = document.getElementById("ppEditBio");
    const bioCount  = document.getElementById("ppBioCount");

    let sb = null;
    let currentUser = null;
    let currentProfile = { display_name: "", bio: "", created_at: null };

    function showError(msg) {
      errEl.textContent = msg;
      errEl.style.display = "block";
      okEl.style.display = "none";
      okEl.textContent = "";
    }
    function showOk(msg) {
      okEl.textContent = msg;
      okEl.style.display = "block";
      errEl.style.display = "none";
      errEl.textContent = "";
      setTimeout(() => { okEl.style.display = "none"; }, 1200);
    }
    function hideMsgs() {
      errEl.style.display = "none";
      errEl.textContent = "";
      okEl.style.display = "none";
      okEl.textContent = "";
    }

    function initialFromName(name) {
      const s = (name || "").trim();
      return s ? s.charAt(0).toUpperCase() : "?";
    }

    // hard header update for THIS page (żeby nie było "Login")
    function hardUpdateHeader(name) {
      const btn = document.querySelector("[data-pp-user-button]");
      const label = document.querySelector("[data-pp-user-label]");
      const av = document.querySelector("[data-pp-user-avatar]");
      if (!btn || !label || !av) return;

      label.textContent = name || "User";
      av.textContent = initialFromName(name);
      av.style.display = "inline-flex";
      btn.href = "/profile.html";
    }

    function waitForSupabaseSDK(cb, startedAt = Date.now()) {
      if (window.supabase && typeof window.supabase.createClient === "function") return cb();
      if (Date.now() - startedAt > 4000) {
        showError("Supabase SDK not loaded.");
        return;
      }
      setTimeout(() => waitForSupabaseSDK(cb, startedAt), 50);
    }

    function setEditMode(on) {
      if (on) {
        editWrap.style.display = "block";
        saveBtn.style.display = "inline-flex";
        cancelBtn.style.display = "inline-flex";
        editBtn.style.display = "none";

        // hide bubble in edit mode
        bioEl.style.display = "none";

        editName.value = currentProfile.display_name || nameEl.textContent || "";
        editBio.value = currentProfile.bio || (bioEl.textContent || "");
        updateBioCount();
      } else {
        editWrap.style.display = "none";
        saveBtn.style.display = "none";
        cancelBtn.style.display = "none";
        editBtn.style.display = "inline-flex";

        // show bubble again
        bioEl.style.display = "";
      }
    }

    function updateBioCount() {
      const len = (editBio.value || "").length;
      bioCount.textContent = `${len} / 240`;
    }
    editBio.addEventListener("input", updateBioCount);

    function validateDisplayName(raw) {
      const name = (raw || "").trim();
      if (name.length < 2) return { ok:false, msg:"Display name too short (min 2)." };
      if (name.length > 20) return { ok:false, msg:"Display name too long (max 20)." };
      if (!/^[A-Za-z0-9._-]+$/.test(name)) {
        return { ok:false, msg:"Use only letters, numbers, . _ - (no spaces)." };
      }
      return { ok:true, value:name };
    }

    function normalizeBio(raw) {
      const bio = (raw || "").trim();
      if (bio.length > 240) return { ok:false, msg:"Bio too long (max 240)." };
      return { ok:true, value:bio };
    }

    // NEW: universal stats from toy_scores
    async function loadToyStats(uid) {
      try {
        const { data, error } = await sb
          .from("toy_scores")
          .select("toy_id, score, meta, created_at")
          .eq("user_id", uid)
          .order("created_at", { ascending: false })
          .limit(300);

        if (error) {
          console.error("toy_scores load error:", error);
          return;
        }
        if (!data || !data.length) return;

        const bestByToy = new Map();

        function better(row) { return (row?.meta?.better || "max"); }
        function isBetter(a, b) {
          return better(a) === "min" ? a.score < b.score : a.score > b.score;
        }

        for (const row of data) {
          const prev = bestByToy.get(row.toy_id);
          if (!prev || isBetter(row, prev)) bestByToy.set(row.toy_id, row);
        }

        statsCard.style.display = "block";

        // clear previous
        statsCard.querySelectorAll(".pp-stat-row, .pp-stats-list").forEach(n => n.remove());

        const list = document.createElement("div");
        list.className = "pp-stats-list";

        const rows = Array.from(bestByToy.entries()).sort((a, b) => a[0].localeCompare(b[0]));

        for (const [toyId, row] of rows) {
          const unit = row?.meta?.unit ? ` ${row.meta.unit}` : "";
          const scoreNum = Number(row.score);
          const pretty = row?.meta?.unit === "ms"
            ? `${scoreNum.toFixed(0)}${unit}`
            : `${scoreNum.toFixed(1)}${unit}`;

          const item = document.createElement("div");
          item.className = "pp-stat-row";
          item.innerHTML = `
            <div class="pp-stat-label">${toyId}</div>
            <div class="pp-stat-value">${pretty}</div>
          `;
          list.appendChild(item);
        }

        statsCard.appendChild(list);
      } catch (e) {
        console.error("loadToyStats crash:", e);
      }
    }

    async function loadProfileAndStats() {
      hideMsgs();
      metaEl.textContent = "Loading profile…";

      const email = currentUser.email || "";
      const meta = currentUser.user_metadata || {};
      const fallbackName =
        meta.display_name ||
        meta.username ||
        (email ? email.split("@")[0] : "Player");

      nameEl.textContent = fallbackName || "Player";
      avatarEl.textContent = initialFromName(fallbackName);
      hardUpdateHeader(fallbackName);

      const uid = currentUser.id;

      const { data: prof, error: profErr } = await sb
        .from("profiles")
        .select("display_name, bio, created_at")
        .eq("user_id", uid)
        .maybeSingle();

      if (profErr) {
        console.error("Profile load error:", profErr);
        showError("Could not load profile.");
        metaEl.textContent = "";
      } else {
        const displayName = (prof && prof.display_name) ? prof.display_name : (fallbackName || "Player");
        const bio = (prof && prof.bio) ? prof.bio : "";

        currentProfile.display_name = displayName;
        currentProfile.bio = bio;
        currentProfile.created_at = prof ? prof.created_at : null;

        nameEl.textContent = displayName;
        avatarEl.textContent = initialFromName(displayName);

        // bubble text
        bioEl.textContent = bio || "";

        hardUpdateHeader(displayName);

        if (prof && prof.created_at) {
          const created = new Date(prof.created_at);
          const dateText = created.toLocaleDateString(undefined, { year:"numeric", month:"short", day:"numeric" });
          metaEl.textContent = `Member since ${dateText}`;
        } else {
          metaEl.textContent = "";
        }
      }

      await loadToyStats(uid);
    }

    async function initProfile() {
      waitForSupabaseSDK(async () => {
        sb = window.ppSupabaseClient || window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const { data: userRes, error: userErr } = await sb.auth.getUser();
        if (userErr) {
          showError("Auth error.");
          return;
        }
        currentUser = userRes?.user;
        if (!currentUser) {
          window.location.href = PP_LOGIN_URL;
          return;
        }

        copyBtn.addEventListener("click", async () => {
          try {
            await navigator.clipboard.writeText(currentUser.id);
            copyBtn.textContent = "Copied!";
            setTimeout(() => (copyBtn.textContent = "Copy user id"), 900);
          } catch {
            showError("Clipboard blocked by browser.");
          }
        });

        logoutBtn.addEventListener("click", async () => {
          logoutBtn.disabled = true;
          const old = logoutBtn.textContent;
          logoutBtn.textContent = "Logging out…";
          try { await sb.auth.signOut(); } catch (e) { console.error(e); }
          window.location.href = PP_LOGIN_URL;
          logoutBtn.textContent = old;
          logoutBtn.disabled = false;
        });

        editBtn.addEventListener("click", () => {
          hideMsgs();
          setEditMode(true);
        });

        cancelBtn.addEventListener("click", () => {
          hideMsgs();
          setEditMode(false);
        });

        saveBtn.addEventListener("click", async () => {
          hideMsgs();

          const vName = validateDisplayName(editName.value);
          if (!vName.ok) return showError(vName.msg);

          const vBio = normalizeBio(editBio.value);
          if (!vBio.ok) return showError(vBio.msg);

          const newName = vName.value;
          const newBio = vBio.value;

          saveBtn.disabled = true;
          cancelBtn.disabled = true;
          editName.disabled = true;
          editBio.disabled = true;
          const oldSave = saveBtn.textContent;
          saveBtn.textContent = "Saving…";

          try {
            const uid = currentUser.id;

            const { error: upErr } = await sb
              .from("profiles")
              .upsert(
                { user_id: uid, display_name: newName, bio: newBio },
                { onConflict: "user_id" }
              );

            if (upErr) {
              console.error("Upsert error:", upErr);
              showError(`Could not save profile: ${upErr.message || "unknown error"}`);
              return;
            }

            const { error: metaErr } = await sb.auth.updateUser({
              data: { display_name: newName }
            });

            if (metaErr) console.warn("Metadata update error:", metaErr);

            currentProfile.display_name = newName;
            currentProfile.bio = newBio;

            nameEl.textContent = newName;
            bioEl.textContent = newBio || "";
            avatarEl.textContent = initialFromName(newName);
            hardUpdateHeader(newName);

            if (window.ppUpdateUserButton) {
              try { await window.ppUpdateUserButton(); } catch {}
            }

            setEditMode(false);
            showOk("Saved.");

          } finally {
            saveBtn.disabled = false;
            cancelBtn.disabled = false;
            editName.disabled = false;
            editBio.disabled = false;
            saveBtn.textContent = oldSave;
          }
        });

        await loadProfileAndStats();
      });
    }

    setTimeout(initProfile, 0);
  </script>
</body>
</html>
