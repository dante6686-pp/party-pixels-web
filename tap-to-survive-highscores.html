<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Tap to Survive – Highscores · Party Pixels</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles.css" />

  <!-- Supabase global CDN (tak jak na index / account) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.48.0/dist/umd/supabase.min.js"></script>
  <!-- Wspólny auth helper -->
  <script src="pp-auth.js"></script>
  <link rel="stylesheet" href="pp-main.css">

  <style>
    .leaderboard-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 12px;
      font-size: 0.9rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: #b4bdf4;
    }

    .leaderboard-header small {
      font-size: 0.8rem;
      color: #c8d0ff;
    }

    table.leaderboard {
      width: 100%;
      border-collapse: collapse;
      border-radius: 18px;
      overflow: hidden;
      background: linear-gradient(135deg, #191731, #101322);
    }

    .leaderboard thead {
      background: rgba(255, 255, 255, 0.04);
      backdrop-filter: blur(10px);
    }

    .leaderboard th,
    .leaderboard td {
      padding: 10px 16px;
      font-size: 0.9rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      white-space: nowrap;
    }

    .leaderboard th {
      text-align: left;
      color: #98a2ff;
      font-weight: 500;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      font-size: 0.75rem;
    }

    .leaderboard th:nth-child(1),
    .leaderboard td:nth-child(1) {
      width: 40px;
      text-align: center;
    }

    .leaderboard th:nth-child(3),
    .leaderboard td:nth-child(3) {
      text-align: right;
    }

    .leaderboard th:nth-child(4),
    .leaderboard td:nth-child(4) {
      text-align: right;
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    tbody tr:hover {
      background: radial-gradient(circle at left, rgba(123, 97, 255, 0.18), transparent);
    }

    .rank-cell {
      font-weight: 600;
      color: #e5e7ff;
      font-variant-numeric: tabular-nums;
    }

    .score-cell {
      font-variant-numeric: tabular-nums;
      color: #fff2b7;
    }

    .when-cell {
      color: #a6b0e2;
      font-size: 0.8rem;
    }

    .you-row {
      background: linear-gradient(90deg, rgba(0, 255, 149, 0.16), transparent);
      box-shadow: inset 2px 0 0 #00ff9d;
    }

    .you-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 2px 8px;
      margin-left: 6px;
      border-radius: 999px;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      background: linear-gradient(90deg, #10b981, #22c55e);
      color: #04110a;
      box-shadow: 0 0 0 1px rgba(3, 255, 150, 0.4);
    }

    .status-line {
      margin-top: 10px;
      font-size: 0.8rem;
      color: #aeb5ff;
    }

    .status-line.error {
      color: #fca5a5;
    }
  </style>
  
</head>
<body>
  <!-- Top bar z Party Pixels – zakładam, że masz go wstawionego już na innych stronach -->
  <header class="pp-topbar">
    <div class="pp-topbar-inner">
      <a href="/index.html" class="pp-logo">
        <span class="pp-dot"></span>
        <span class="pp-wordmark">Party<br />Pixels</span>
      </a>
      <div class="pp-topbar-right">
        <span class="pp-user-badge" data-pp-user-badge>Checking auth…</span>
        <a href="/account.html" data-pp-account-link class="pp-account-btn">Account</a>
      </div>
    </div>
  </header>

  <main class="page-wrap">
    <a href="/tap-to-survive.html" class="back-link">← Back to game</a>

    <h1>Tap to Survive – Highscores</h1>
    <p class="subtitle">Top runs from all Party Pixels players.</p>

    <section class="card">
      <div class="leaderboard-header">
        <span>LEADERBOARD</span>
        <span><strong>Best times (seconds).</strong> Higher = you survived longer.</span>
      </div>

      <table class="leaderboard">
        <thead>
          <tr>
            <th>#</th>
            <th>Player</th>
            <th>Best time (s)</th>
            <th>When</th>
          </tr>
        </thead>
        <tbody id="leaderboardBody">
          <tr>
            <td colspan="4">Loading highscores…</td>
          </tr>
        </tbody>
      </table>

      <div id="leaderboardStatus" class="status-line">
        Loading highscores…
      </div>
    </section>

    <p class="status-line" style="margin-top:16px;">
      Party Pixels · Tap to Survive<br />
      Prototype web toy with Supabase highscores.
    </p>
  </main>

  <script>
    // Maskowanie maila
    function maskEmail(email) {
      if (!email || typeof email !== "string") return "(unknown)";
      const [name, domain] = email.split("@");
      if (!domain) return email;
      if (name.length <= 2) return email;
      const visible = name.slice(0, 2);
      return visible + "***@" + domain;
    }

    function formatWhen(ts) {
      try {
        if (!ts) return "";
        const d = new Date(ts);
        if (isNaN(d.getTime())) {
          console.warn("Cannot parse created_at:", ts);
          return "";
        }

        const now = new Date();
        const diffMs = now - d;
        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

        const time = d.toLocaleTimeString([], {
          hour: "2-digit",
          minute: "2-digit"
        });

        const sameDay =
          d.getDate() === now.getDate() &&
          d.getMonth() === now.getMonth() &&
          d.getFullYear() === now.getFullYear();

        if (sameDay) return "Today, " + time;

        const yesterday = new Date(now);
        yesterday.setDate(now.getDate() - 1);

        const isYesterday =
          d.getDate() === yesterday.getDate() &&
          d.getMonth() === yesterday.getMonth() &&
          d.getFullYear() === yesterday.getFullYear();

        if (isYesterday) return "Yesterday, " + time;

        if (diffDays < 7) return diffDays + " days ago";

        return (
          d.toLocaleDateString(undefined, {
            year: "numeric",
            month: "short",
            day: "numeric"
          }) + " — " + time
        );
      } catch (e) {
        console.error("formatWhen error", e);
        return "";
      }
    }

    document.addEventListener("DOMContentLoaded", async () => {
      const tbody = document.getElementById("leaderboardBody");
      const statusEl = document.getElementById("leaderboardStatus");

      if (!tbody || !statusEl) {
        console.error("Leaderboard DOM elements not found");
        return;
      }

      statusEl.textContent = "Loading highscores…";

      if (typeof window.ppSupabase === "undefined") {
        console.error("ppSupabase is not available on window");
        tbody.innerHTML =
          '<tr><td colspan="4">Leaderboard not available (auth client not loaded).</td></tr>';
        statusEl.textContent =
          "Leaderboard not available (auth client not loaded).";
        statusEl.classList.add("error");
        return;
      }

      try {
        // aktualny user (do YOU ★)
        const { data: userData, error: userErr } =
          await window.ppSupabase.auth.getUser();
        if (userErr) console.warn("auth.getUser error", userErr);
        const currentUser = userData?.user || null;
        const currentEmail = currentUser?.email || null;

        // pobierz wyniki
        const { data, error } = await window.ppSupabase
          .from("tts_scores")
          .select("email, score, created_at")
          .order("score", { ascending: false })
          .limit(200);

        if (error) {
          console.error("Error loading highscores:", error);
          tbody.innerHTML =
            '<tr><td colspan="4">Error loading highscores.</td></tr>';
          statusEl.textContent = "Error loading highscores.";
          statusEl.classList.add("error");
          return;
        }

        if (!data || data.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="4">No scores yet. Be the first to die gloriously.</td></tr>';
          statusEl.textContent =
            "No scores yet. Be the first to die gloriously.";
          return;
        }

        // best run per email
        const bestByEmail = {};
        data.forEach((row) => {
          const email = row.email || "(unknown)";
          const scoreNum = Number(row.score) || 0;
          if (!bestByEmail[email] || scoreNum > bestByEmail[email].score) {
            bestByEmail[email] = {
              email,
              score: scoreNum,
              created_at: row.created_at
            };
          }
        });

        const rows = Object.values(bestByEmail).sort(
          (a, b) => b.score - a.score
        );

        tbody.innerHTML = "";
        let yourRank = null;

        rows.forEach((row, index) => {
          const tr = document.createElement("tr");
          const rank = index + 1;

          const tdRank = document.createElement("td");
          tdRank.textContent = rank;
          tdRank.className = "rank-cell";
          tr.appendChild(tdRank);

          const tdPlayer = document.createElement("td");
          const label = document.createElement("span");
          label.textContent = maskEmail(row.email);
          tdPlayer.appendChild(label);

          if (currentEmail && row.email === currentEmail) {
            const badge = document.createElement("span");
            badge.textContent = "YOU ★";
            badge.className = "you-badge";
            tdPlayer.appendChild(badge);
            tr.classList.add("you-row");
            yourRank = rank;
          }

          tr.appendChild(tdPlayer);

          const tdScore = document.createElement("td");
          tdScore.textContent = row.score.toFixed(1);
          tdScore.className = "score-cell";
          tr.appendChild(tdScore);

          const tdWhen = document.createElement("td");
          tdWhen.textContent = formatWhen(row.created_at);
          tdWhen.className = "when-cell";
          tr.appendChild(tdWhen);

          tbody.appendChild(tr);
        });

        if (yourRank !== null) {
          statusEl.textContent =
            "Showing best run per player. Your rank: #" + yourRank + ".";
        } else {
          statusEl.textContent = "Showing best run per player.";
        }
      } catch (err) {
        console.error("Unexpected error while loading highscores", err);
        tbody.innerHTML =
          '<tr><td colspan="4">Unexpected error while loading highscores.</td></tr>';
        statusEl.textContent =
          "Unexpected error while loading highscores.";
        statusEl.classList.add("error");
      }
    });
  </script>
</body>
</html>
