<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Party Pixels · Highscores</title>
  <link rel="stylesheet" href="/pp-main.css" />

  <style>
    .pp-wrap { max-width: 980px; margin: 0 auto; padding: 22px 16px 64px; }
    .pp-row { display:flex; justify-content:space-between; align-items:baseline; gap:12px; flex-wrap:wrap; }
    .pp-h1 { font-size: 26px; margin: 10px 0 6px; }
    .pp-sub { color: var(--muted); margin: 0 0 18px; }

    .pp-card {
      border-radius: 18px;
      padding: 14px 14px 16px;
      background:
        radial-gradient(circle at top left, rgba(255, 92, 255, 0.12), transparent 55%),
        radial-gradient(circle at bottom right, rgba(92, 138, 255, 0.18), transparent 65%),
        rgba(7, 11, 32, 0.92);
      border: 1px solid rgba(255,255,255,0.06);
      box-shadow: 0 18px 45px rgba(0,0,0,0.45);
    }

    .pp-back { font-size: 12px; color: var(--muted); text-decoration:none; border-bottom:1px dotted rgba(154,156,210,0.4); }
    .pp-back:hover { color: var(--text); }

    table.pp-table { width:100%; border-collapse: collapse; overflow:hidden; border-radius: 14px; }
    .pp-table thead { background: rgba(255,255,255,0.05); }
    .pp-table th, .pp-table td {
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      font-size: 13px;
      white-space: nowrap;
    }
    .pp-table th { text-align:left; color: rgba(180,190,255,0.95); font-size: 11px; letter-spacing: .14em; text-transform: uppercase; }
    .pp-table th:nth-child(1), .pp-table td:nth-child(1) { width: 48px; text-align:center; }
    .pp-table th:nth-child(3), .pp-table td:nth-child(3) { text-align:right; }
    .pp-table th:nth-child(4), .pp-table td:nth-child(4) { text-align:right; }

    .pp-score { color: #fff2b7; font-variant-numeric: tabular-nums; }
    .pp-when { color: var(--muted); font-size: 12px; }

    .pp-you { background: linear-gradient(90deg, rgba(0,255,149,0.14), transparent); box-shadow: inset 2px 0 0 rgba(0,255,149,0.55); }
    .pp-you-badge {
      display:inline-flex; align-items:center; justify-content:center;
      margin-left: 8px; padding: 2px 8px; border-radius: 999px;
      font-size: 10px; letter-spacing: .16em; text-transform: uppercase;
      background: linear-gradient(90deg,#10b981,#22c55e); color:#04110a;
      box-shadow: 0 0 0 1px rgba(3,255,150,0.35);
    }

    .pp-status { margin-top: 10px; color: var(--muted); font-size: 12px; }
    .pp-status.err { color: #ffb4b4; }
  </style>
</head>

<body>
  <div class="page">
    <div id="header"></div>

    <main class="pp-wrap">
      <div class="pp-row">
        <a class="pp-back" id="ppBackLink" href="/index.html">← Back</a>
        <div></div>
      </div>

      <h1 class="pp-h1" id="ppTitle">Highscores</h1>
      <p class="pp-sub" id="ppSubtitle">Best runs from Party Pixels players.</p>

      <section class="pp-card">
        <table class="pp-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Player</th>
              <th>Score</th>
              <th>When</th>
            </tr>
          </thead>
          <tbody id="ppBody">
            <tr><td colspan="4">Loading…</td></tr>
          </tbody>
        </table>

        <div class="pp-status" id="ppStatus">Loading…</div>
      </section>
    </main>

    <div id="footer"></div>
  </div>

  <!-- PARTS -->
  <script>
    function loadPart(id, file, cb) {
      fetch(file).then(r => r.text()).then(html => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = html;
        if (typeof cb === "function") cb();
      }).catch(err => console.error("Load error:", file, err));
    }
    loadPart("header", "/header.html", () => {
      if (window.ppUpdateUserButton) window.ppUpdateUserButton();
    });
    loadPart("footer", "/footer.html");
  </script>

  <!-- Supabase + auth -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/pp-auth.js"></script>

  <script>
    const titleEl = document.getElementById("ppTitle");
    const subEl   = document.getElementById("ppSubtitle");
    const bodyEl  = document.getElementById("ppBody");
    const statusEl= document.getElementById("ppStatus");
    const backEl  = document.getElementById("ppBackLink");

    function fmtWhen(ts) {
      if (!ts) return "";
      const d = new Date(ts);
      if (isNaN(d.getTime())) return "";
      return d.toLocaleDateString(undefined, { year:"numeric", month:"short", day:"numeric" }) +
        " · " +
        d.toLocaleTimeString([], { hour:"2-digit", minute:"2-digit" });
    }

    function escapeHtml(s) {
      return String(s ?? "").replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[c]));
    }

    async function run() {
      const params = new URLSearchParams(location.search);
      const toyId = (params.get("toy") || "").trim();

      if (!toyId) {
        titleEl.textContent = "Highscores";
        subEl.textContent = "Missing ?toy=…";
        bodyEl.innerHTML = `<tr><td colspan="4">Missing toy id.</td></tr>`;
        statusEl.textContent = "Add ?toy=tap-to-survive (example).";
        statusEl.classList.add("err");
        return;
      }

      // set title + back link
      titleEl.textContent = `Highscores · ${toyId}`;
      backEl.href = `/${toyId}.html`.includes("tap-to-survive.html") ? "/tap-to-survive.html" : "/index.html";
      backEl.textContent = "← Back";

      // need client
      const sb = window.ppSupabaseClient;
      if (!sb) {
        bodyEl.innerHTML = `<tr><td colspan="4">Auth client not ready.</td></tr>`;
        statusEl.textContent = "pp-auth.js / supabase not loaded.";
        statusEl.classList.add("err");
        return;
      }

      statusEl.textContent = "Loading…";

      // current user (optional)
      let currentUid = null;
      try {
        const { data } = await sb.auth.getUser();
        currentUid = data?.user?.id || null;
      } catch {}

      // 1) get best rows per user for this toy
      // We'll load latest N rows and reduce client-side (good enough for v1).
      const { data: rows, error } = await sb
        .from("toy_scores")
        .select("user_id, toy_id, score, created_at")
        .eq("toy_id", toyId)
        .order("score", { ascending: false })
        .limit(500);

      if (error) {
        console.error(error);
        bodyEl.innerHTML = `<tr><td colspan="4">Error loading highscores.</td></tr>`;
        statusEl.textContent = error.message || "Error.";
        statusEl.classList.add("err");
        return;
      }

      if (!rows || rows.length === 0) {
        bodyEl.innerHTML = `<tr><td colspan="4">No scores yet.</td></tr>`;
        statusEl.textContent = "Be the first to die gloriously.";
        return;
      }

      // best per user
      const bestByUser = new Map();
      for (const r of rows) {
        const uid = r.user_id;
        if (!uid) continue;
        if (!bestByUser.has(uid) || Number(r.score) > Number(bestByUser.get(uid).score)) {
          bestByUser.set(uid, r);
        }
      }
      const best = Array.from(bestByUser.values()).sort((a,b) => Number(b.score) - Number(a.score)).slice(0, 200);

      // 2) load profiles for display_name
      const userIds = best.map(r => r.user_id);
      const { data: profs } = await sb
        .from("profiles")
        .select("user_id, display_name")
        .in("user_id", userIds);

      const nameByUser = new Map((profs || []).map(p => [p.user_id, p.display_name || "Player"]));

      bodyEl.innerHTML = "";
      best.forEach((r, idx) => {
        const rank = idx + 1;
        const name = nameByUser.get(r.user_id) || "Player";
        const isYou = currentUid && r.user_id === currentUid;

        const tr = document.createElement("tr");
        if (isYou) tr.classList.add("pp-you");

        tr.innerHTML = `
          <td>${rank}</td>
          <td>
            ${escapeHtml(name)}
            ${isYou ? `<span class="pp-you-badge">YOU</span>` : ""}
          </td>
          <td class="pp-score">${Number(r.score).toFixed(1)}</td>
          <td class="pp-when">${escapeHtml(fmtWhen(r.created_at))}</td>
        `;
        bodyEl.appendChild(tr);
      });

      statusEl.textContent = "Showing best run per player.";
    }

    document.addEventListener("DOMContentLoaded", run);
  </script>
</body>
</html>
