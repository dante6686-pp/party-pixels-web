<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Party Pixels ¬∑ Tap to Survive</title>

  <link rel="stylesheet" href="/pp-main.css" />

  <!-- Page-specific styles only -->
  <style>
    /* optional: per-toy background image (if you want to override global) */
    /* body::before { background-image: url('/media/tts-splash.png'); } */

    .pp-toy-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 14px;
    }

    .pp-toy-title {
      font-size: 22px;
      font-weight: 700;
      margin: 0;
    }

    .pp-toy-subtitle {
      margin: 6px 0 0;
      font-size: 13px;
      color: var(--muted);
      max-width: 640px;
    }

    .pp-back-link {
      font-size: 12px;
      text-decoration: none;
      color: var(--muted);
      border-bottom: 1px dotted rgba(154, 156, 210, 0.4);
      white-space: nowrap;
    }
    .pp-back-link:hover { color: var(--text); }

    .pp-game-card {
      position: relative;
      border-radius: 18px;
      padding: 14px 12px 14px;
      background:
        radial-gradient(circle at top, rgba(255, 92, 255, 0.15), transparent 55%),
        radial-gradient(circle at bottom right, rgba(92, 138, 255, 0.25), transparent 65%),
        linear-gradient(145deg, rgba(10, 14, 35, 0.96), rgba(4, 5, 14, 0.98));
      border: 1px solid var(--border);
      box-shadow: 0 14px 40px rgba(0, 0, 0, 0.7);
    }

    .pp-section-label {
      font-size: 11px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: var(--muted);
      margin: 0 0 10px;
    }

    .pp-life-shell {
      width: 100%;
      height: 14px;
      border-radius: 999px;
      border: 1px solid rgba(120, 40, 80, 0.8);
      background: rgba(9, 9, 23, 0.95);
      overflow: hidden;
      margin-bottom: 6px;
    }
    .pp-life-fill {
      width: 100%;
      height: 100%;
      border-radius: 999px;
      background: linear-gradient(90deg, #4ade80, #facc15, #fb7185);
      transition: width 0.08s linear;
    }
    .pp-life-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 12px;
    }

    .pp-game-layout {
      display: grid;
      grid-template-columns: minmax(0, 1.7fr) minmax(0, 1.3fr);
      gap: 14px;
    }
    @media (max-width: 720px) {
      .pp-game-layout { grid-template-columns: 1fr; }
    }

    .pp-char-card {
      border-radius: 16px;
      border: 1px solid rgba(56, 63, 120, 0.9);
      background: radial-gradient(circle at top left, rgba(255, 92, 92, 0.2), rgba(5, 7, 18, 0.96));
      padding: 10px 12px;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .pp-char-avatar {
      width: 56px;
      height: 56px;
      border-radius: 18px;
      background: radial-gradient(circle at top, #fb7185, #7f1d1d);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      user-select: none;
    }
    .pp-char-name { font-size: 13px; font-weight: 600; }
    .pp-char-quote { font-size: 12px; color: var(--muted); }
    .pp-char-mode { font-size: 11px; margin-top: 4px; color: #facc15; }

    .pp-game-buttons {
      display: flex;
      gap: 10px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .pp-btn-main {
      flex: 1;
      min-width: 210px;
      padding: 10px 14px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: #fff;
      font-size: 13px;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      cursor: pointer;
      box-shadow: 0 12px 26px rgba(0,0,0,0.35);
    }
    .pp-btn-main:disabled { opacity: 0.5; cursor: default; }

    .pp-btn-ghost {
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid rgba(99, 102, 241, 0.7);
      background: rgba(11, 15, 40, 0.95);
      color: var(--text);
      font-size: 13px;
      cursor: pointer;
    }
    .pp-btn-ghost:disabled { opacity: 0.4; cursor: default; }

    .pp-stats-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
      font-size: 11px;
      color: var(--muted);
    }
    .pp-stat-pill {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(46, 51, 100, 0.9);
      background: rgba(6, 9, 24, 0.96);
      white-space: nowrap;
    }

    .pp-side-card {
      border-radius: 16px;
      border: 1px solid rgba(56, 63, 120, 0.9);
      background: rgba(7, 9, 24, 0.96);
      padding: 10px 12px;
      font-size: 12px;
      color: var(--muted);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .pp-game-message {
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
    }
    .pp-game-message.is-dead { color: #ff7a7a; }

    .pp-mini-link {
      margin-top: 8px;
      font-size: 12px;
    }
    .pp-mini-link a {
      color: var(--muted);
      text-decoration: none;
      border-bottom: 1px dotted rgba(154, 156, 210, 0.4);
    }
    .pp-mini-link a:hover { color: var(--text); }
  </style>
</head>

<body>
  <div class="page">
    <div id="header"></div>

    <main>
      <div class="pp-toy-header">
        <div>
          <h1 class="pp-toy-title">Tap to Survive</h1>
          <p class="pp-toy-subtitle">
            Panic mini-game: your life drains constantly. Tap to stay alive as long as you can.
          </p>
        </div>
        <a class="pp-back-link" href="/index.html">‚Üê Back to Web Toys</a>
      </div>

      <section class="pp-game-card">
        <p class="pp-section-label">Game</p>

        <div class="pp-life-shell">
          <div id="lifeBar" class="pp-life-fill"></div>
        </div>
        <div class="pp-life-row">
          <span>Life</span>
          <span id="lifeText">100 / 100</span>
        </div>

        <div class="pp-game-layout">
          <!-- LEFT -->
          <div>
            <div class="pp-char-card">
              <div id="charAvatar" class="pp-char-avatar">üòé</div>
              <div>
                <div class="pp-char-name">Little Survivor</div>
                <div id="charStatus" class="pp-char-quote">"This is fine."</div>
                <div id="charMode" class="pp-char-mode">Normal mode</div>
              </div>
            </div>

            <div class="pp-game-buttons">
              <button id="tapButton" class="pp-btn-main">Tap to survive</button>
              <button id="restartButton" class="pp-btn-ghost" disabled>Restart run</button>
            </div>

            <div class="pp-stats-row">
              <div class="pp-stat-pill">Time survived: <span id="timeSurvived">0.0</span>s</div>
              <div class="pp-stat-pill">Best (local): <span id="bestTime">0.0</span>s</div>
              <div class="pp-stat-pill">Taps: <span id="tapCount">0</span></div>
            </div>

            <div id="gameMessage" class="pp-game-message">
              Keep tapping before the bar hits zero.
            </div>

            <div class="pp-mini-link">
              <a href="/tap-to-survive-highscores.html">View global highscores ‚Üí</a>
            </div>
          </div>

          <!-- RIGHT -->
          <aside class="pp-side-card">
            <strong>How it works</strong>
            <span>‚Ä¢ Your life drains automatically over time.</span>
            <span>‚Ä¢ Every tap restores a bit of life.</span>
            <span>‚Ä¢ If you‚Äôre logged in, your best run saves to your profile stats.</span>
            <span>‚Ä¢ Mobile tip: spam that thumb, but watch your screen üòâ</span>
          </aside>
        </div>
      </section>
    </main>

    <div id="footer"></div>
  </div>

  <!-- PARTS loader -->
  <script>
    function loadPart(id, file, cb) {
      fetch(file)
        .then(r => r.text())
        .then(html => {
          const el = document.getElementById(id);
          if (el) el.innerHTML = html;
          if (typeof cb === "function") cb();
        })
        .catch(err => console.error("Load error:", file, err));
    }

    loadPart("header", "/header.html", () => {
      if (window.ppUpdateUserButton) window.ppUpdateUserButton();
    });
    loadPart("footer", "/footer.html");
  </script>

  <!-- Supabase + auth (needed for ppSaveToyScore) + tipjar -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/pp-auth.js"></script>
  <script src="/tipjar.js"></script>

  <!-- GAME LOGIC + SAVE TO toy_scores -->
  <script>
    // ---- Local best ----
    const LS_KEY = "tts-best";
    let bestTime = Number(localStorage.getItem(LS_KEY) || 0);

    // ---- Game state ----
    const maxLife = 100;
    let life = maxLife;
    let running = true;
    let tapCount = 0;
    let timeSurvived = 0;
    let lastTimestamp = performance.now();

    const drainPerSecond = 7;
    const healPerTap = 5;

    // ---- UI refs ----
    const lifeBar = document.getElementById("lifeBar");
    const lifeText = document.getElementById("lifeText");
    const tapButton = document.getElementById("tapButton");
    const restartButton = document.getElementById("restartButton");
    const timeSurvivedEl = document.getElementById("timeSurvived");
    const bestTimeEl = document.getElementById("bestTime");
    const tapCountEl = document.getElementById("tapCount");
    const gameMessage = document.getElementById("gameMessage");
    const charAvatar = document.getElementById("charAvatar");
    const charStatus = document.getElementById("charStatus");
    const charMode = document.getElementById("charMode");

    bestTimeEl.textContent = bestTime.toFixed(1);

    function updateUI() {
      const pct = Math.max(0, Math.min(1, life / maxLife));
      lifeBar.style.width = (pct * 100) + "%";
      lifeText.textContent = `${Math.max(0, Math.round(life))} / ${maxLife}`;
      timeSurvivedEl.textContent = timeSurvived.toFixed(1);
      bestTimeEl.textContent = bestTime.toFixed(1);
      tapCountEl.textContent = tapCount;

      if (!running && life <= 0) {
        gameMessage.classList.add("is-dead");
        charAvatar.textContent = "üíÄ";
        charStatus.textContent = `"Ok, that hurt."`;
        charMode.textContent = "Game over";
      } else {
        gameMessage.classList.remove("is-dead");
      }

      const pct2 = Math.max(0, Math.min(1, life / maxLife));
      if (pct2 > 0.6 && running) {
        charAvatar.textContent = "üòé";
        charStatus.textContent = `"This is fine."`;
        charMode.textContent = "Normal mode";
      } else if (pct2 > 0.3 && running) {
        charAvatar.textContent = "üò∞";
        charStatus.textContent = `"Starting to panic a bit."`;
        charMode.textContent = "Getting spicy";
      } else if (pct2 > 0 && running) {
        charAvatar.textContent = "üò±";
        charStatus.textContent = `"HELP. TAP FASTER."`;
        charMode.textContent = "Panic mode";
      }
    }

    function resetGame() {
      life = maxLife;
      timeSurvived = 0;
      tapCount = 0;
      running = true;
      lastTimestamp = performance.now();
      tapButton.disabled = false;
      restartButton.disabled = true;
      gameMessage.textContent = "Keep tapping before the bar hits zero.";
      charMode.textContent = "Normal mode";
      updateUI();
    }

    async function saveBestOnline(seconds) {
      // silent: if not logged in or client missing -> just return ok:false
      if (!window.ppSaveToyScore) return { ok:false, error:"ppSaveToyScore missing" };

      return await window.ppSaveToyScore(
        "tap-to-survive",
        Number(seconds),
        { better: "max", unit: "s" }
      );
    }

    async function handleRunEnd() {
      running = false;
      tapButton.disabled = true;
      restartButton.disabled = false;

      const score = Number(timeSurvived.toFixed(1));

      if (score > bestTime) {
        bestTime = score;
        localStorage.setItem(LS_KEY, String(bestTime));
        gameMessage.textContent = `New best: ${bestTime.toFixed(1)}s`;

        // try online save (non-blocking UX message)
        const res = await saveBestOnline(bestTime);

        if (res && res.ok) {
          gameMessage.textContent = `New best: ${bestTime.toFixed(1)}s ¬∑ saved to profile ‚úÖ`;
          charMode.textContent = "Record saved";
        } else {
          // not logged in / client missing / etc -> keep it friendly
          gameMessage.textContent = `New best: ${bestTime.toFixed(1)}s ¬∑ log in to save it to your profile.`;
        }
      } else {
        gameMessage.textContent = `You died. Time: ${score.toFixed(1)}s (no new record).`;
      }

      updateUI();
    }

    function gameLoop(now) {
      const deltaSeconds = (now - lastTimestamp) / 1000;
      lastTimestamp = now;

      if (running) {
        life -= drainPerSecond * deltaSeconds;
        timeSurvived += deltaSeconds;

        if (life <= 0) {
          life = 0;
          handleRunEnd();
        }

        updateUI();
      }

      requestAnimationFrame(gameLoop);
    }

    tapButton.addEventListener("click", () => {
      if (!running) return;
      life = Math.min(maxLife, life + healPerTap);
      tapCount += 1;
      updateUI();
    });

    restartButton.addEventListener("click", resetGame);

    // start
    resetGame();
    requestAnimationFrame(gameLoop);
  </script>
</body>
</html>
